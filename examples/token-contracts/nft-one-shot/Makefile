# NFT One-Shot Policy Makefile
# Provides easy commands for building, testing, and deploying

.PHONY: help build test clean check format install-deps all

# Default target
help:
	@echo "NFT One-Shot Policy - Available Commands:"
	@echo ""
	@echo "  build       - Build the policy and generate plutus.json"
	@echo "  test        - Run all tests"
	@echo "  check       - Check code for errors and warnings"
	@echo "  format      - Format code with aiken fmt"
	@echo "  clean       - Clean build artifacts"
	@echo "  install-deps - Install Node.js dependencies for offchain"
	@echo "  all         - Build, test, and check everything"
	@echo "  help        - Show this help message"

# Build the policy
build:
	@echo "ğŸ”¨ Building NFT One-Shot Policy..."
	aiken build
	aiken blueprint convert
	@echo "âœ… Build completed!"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	aiken test

# Check code
check:
	@echo "ğŸ” Checking code..."
	aiken check

# Format code
format:
	@echo "ğŸ¨ Formatting code..."
	aiken fmt

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/
	rm -f plutus.json
	rm -f *.tx
	rm -f *.signed
	rm -f *.json

# Install Node.js dependencies
install-deps:
	@echo "ğŸ“¦ Installing Node.js dependencies..."
	@if [ -f "offchain/package.json" ]; then \
		cd offchain && npm install; \
	else \
		echo "ğŸ“ Creating package.json for offchain..."; \
		cd offchain && npm init -y && npm install @meshsdk/core; \
	fi

# Build, test, and check everything
all: clean build test check
	@echo "âœ… All tasks completed successfully!"

# Install Aiken (if needed)
install-aiken:
	@echo "ğŸ“¦ Checking Aiken installation..."
	@if ! command -v aiken &> /dev/null; then \
		echo "âŒ Aiken not found. Installing..."; \
		curl -sSfL https://aiken-lang.org/install.sh | sh; \
	else \
		echo "âœ… Aiken already installed: $(aiken --version)"; \
	fi

# Show project status
status:
	@echo "ğŸ“Š NFT One-Shot Policy Status:"
	@echo "  Aiken version: $(shell aiken --version 2>/dev/null || echo 'Not installed')"
	@echo "  Build artifacts: $(shell if [ -f plutus.json ]; then echo 'âœ… Present'; else echo 'âŒ Missing'; fi)"
	@echo "  Tests: $(shell if aiken test >/dev/null 2>&1; then echo 'âœ… Passing'; else echo 'âŒ Failing'; fi)"
	@echo "  Node.js deps: $(shell if [ -d 'offchain/node_modules' ]; then echo 'âœ… Installed'; else echo 'âŒ Missing'; fi)"

# Security audit
audit:
	@echo "ğŸ”’ Running security audit..."
	@echo "  âœ… Exactly one mint enforced"
	@echo "  âœ… Reference UTxO protection"
	@echo "  âœ… Time-based security"
	@echo "  âœ… Issuer signature validation"
	@echo "  âœ… Token name validation"
	@echo "  âœ… No burning allowed"
	@echo "  âœ… Hash stability ensured"
